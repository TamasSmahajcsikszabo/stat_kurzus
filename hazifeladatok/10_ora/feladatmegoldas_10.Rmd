---
title: "Házi feladatok megoldása 10."
subtitle: "Modell-alapú klaszteranalízis (MKA) R-ben"
csl: apa7.csl
output:
  pdf_document: default
  html_document:
    df_print: paged
  word_document: default
---

Smahajcsik-Szabó Tamás, M9IJYM



```{r echo=FALSE}
# importing C++ code, R libraries and data
options(warn=-1)
#setwd('/home/tamas/repos/stat_kurzus/hazifeladatok/7_ora')
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
suppressMessages(source("../../src/functions.R"))
#suppressMessages(source("../../src/mad.R"))
suppressMessages(library(readr))
suppressMessages(library(ggrepel))
suppressMessages(library(tidyverse))
suppressMessages(library(effsize))
suppressMessages(library(AICcmodavg))
suppressMessages(library(broom))
suppressMessages(library(confreq))
suppressMessages(library(stringr))
suppressMessages(library(kableExtra))
suppressMessages(library(caret))
suppressMessages(library(tidyverse))
suppressMessages(library(dendextend))
suppressMessages(library(ggdendro))
suppressMessages(library(stats))
suppressMessages(library(ClusterR))
suppressMessages(library(ggpubr))
suppressMessages(library(cluster))
suppressMessages(library(mclust))
#suppressMessages(dataset <- read_csv("../../data/data.csv"))
# suppressMessages(labels <- read_csv('../../data/labels.csv'))

```

## 1. Végezz MKA-t a PTELJ, Pboldog, Pmagány input változókkal, outlier kiszűréssel! Melyik megoldás tűnik a legjobbnak a BIC-grafikon alapján?


Az *mclust* programcsomag *Mclust()* függvényét használva, különböző **G** érték-konfigurációkat teszteltem a BIC legnagyobb értékét, de ugyanakkor a képződő struktúra értelmezhetőségét is szem előtt tartva. 
3 és 30 között vizsgálódva elmondható, hogy alapvetően három olyan keverékeloszlás típus mutatkozott meg, melynél a Bayes-féle Információs Kritérium a legjobb értéket érte el. 
Ebben a nagy tartományban a G=28 esetben az EEV típus mutatta a lejobb BIC értéket, utána visszafelé haladva, a VEV áll G=24-nél, majd pedig a VEI típus illeszkedésénél  legjobb BIC G=15-nél.

```{r echo=FALSE, fig.width=12, fig.height=7}

mka3fit <- readRDS("output/mclust_fit3.RDS")
mka10fit <- readRDS("output/mclust_fit10.RDS")
mka30fit <- readRDS("output/mclust_fit30.RDS")
mute(mka30fit["BIC plot"])
```

**1. ábra** MKA BIC eredmények G=3 és G=30 között

Az alábbi ábrán az egyes keverék-komponensek sűrűségét, illetve box-whiskers eloszlásait látjuk.

```{r echo=FALSE, fig.width=12, fig.height=7}

mute(mka30fit["density plot"])
```

**2. ábra** MKA sűrűség és eloszlási eredmények G=28 között

Mindezeken túl azonban, az értelmezhetőség végett az elemzést a G=3 és G=10 tartományra is megismételtem.


```{r echo=FALSE, fig.width=12, fig.height=7}

mute(mka10fit["BIC plot"])
```

**3. ábra** MKA BIC eredmények G=3 és G=10 között

Ezen elemzés nyomán azt látjuk, a VEV eloszlástípus bizonyul a legjobbnak, mely a fenti, kiterjesztett elemzésnél is a legjobbak között volt, így az képződött struktúra értelmezhetőségének reményében a G=10, VEV struktúrát fogadom el.

Ha az keverékkomponensek sűrűségét tekintjük (alábbi, 4. ábra)

```{r echo=FALSE, fig.width=12, fig.height=7}

mute(mka10fit["density plot"])
```

**4. ábra** MKA sűrűség és eloszlási eredmények G=10 között

A keverékkomponensek sűrűsödés vizsgálata három jobban elkülönölő struktúrát jelez, így mindez felveti hipotézisként, vajon mennyire értelmezhetőbb egy G=3 struktúra az információveszteség ellenére a G=10-zel szemben. 

```{r echo=FALSE, fig.width=8, fig.height=4}

mute(mka3fit["boundary plot"])
```

```{r echo=FALSE, fig.width=8, fig.height=4}

mute(mka10fit["boundary plot"])

```

**5.ábra** A G=3 és a G=10 struktúrák összevetése az adatok első két főkomponense mentén képzett két dimenziós síkban; a klaszterhatárok bizonytalanságát a háttér árnyalata (*z-paraméter*) jelzi.

Noha értelmezhetőbb struktúrát kapunk G=3 értékkel, ez jelentősen rosszabb BIC struktúra mint a G=10.

\newpage

## 2. Készítsd el az 1. feladat BIC-grafikonját k = 3 és 10 között!

```{r echo=FALSE, fig.width=10, fig.height=7}

mute(mka10fit["BIC plot"])
```

**6. ábra** MKA sűrűség és eloszlási eredmények G=10 között

BIC ábráimon a szövegdobozok az adott keveréktípus maximuális értékénél állnak. Ennek értelmében G=10-nél a legjobbnak tűnő eloszlástípus a VEV, melynek BIC értéke -3183.38.

\newpage

## 3. Készítsd el az 1. feladat legjobb BIC megoldásának classification ábráját!


```{r echo=FALSE, fig.width=7, fig.height=7}
mkafit<-readRDS("output/G10fit.RDS")
plot(mkafit, "classification", colors=get_color_scale(3))
```
**7. ábra** A G=10 megoldás klasszifikációs ábrája

Jól látható három nagyobb klaszter elkülönülése, és több kisebb, részben átfedő struktúra is. Ez ismét felveti a kérdést, mennyiben értelmezhetőbb egy G=3 struktúra. Különösen a Boldogság és Magányosság szeleteiben láthatóak néhány személyt magukban foglaló apró klaszterek.

\newpage
```{r echo=FALSE, fig.width=7, fig.height=7}
mkafit<-readRDS("output/G3fit.RDS")
plot(mkafit, "classification", colors=get_color_scale(3))
```
**8. ábra** A G=3 megoldás klasszifikációs ábrája


A BIC-értékben való csökkenés ellenére egy jobban értelmezhető, kevésbé átfedő, kevésbé redundáns megoldást kapunk.


\newpage

## 4. Készítsd el az 1. feladat legjobb BIC megoldásának uncertainty és density ábráját!

```{r echo=FALSE, fig.width=7, fig.height=4}
mkafit<-readRDS("output/G10fit.RDS")
plot(mkafit, "uncertainty", colors=get_color_scale(3))
plot(mkafit, "density")

```
**9. ábra** A G=10 megoldás "uncertainty"  és sűrűsödés ábrája


G=10 esetében a klaszterek átfednek, több esetben is a klaszterbe tartozás bizonytalansága emelkedett.

```{r echo=FALSE, fig.width=7, fig.height=4}
mkafit<-readRDS("output/G3fit.RDS")
plot(mkafit, "uncertainty", colors=get_color_scale(3))
plot(mkafit, "density")
```
**10. ábra** A G=3 megoldás "uncertainty" és sűrűsödés ábrája


\newpage

## 5. Készítsd el az 1. feladat ICL-grafikonját k = 1 és 9 között! Ugyanaz a modell tűnik a legjobbnak, mint a BIC-grafikon alapján?

```{r echo=FALSE, fig.width=6, fig.height=4}
iclFit <- readRDS("output/icl_fit.RDS")
iclFitPrior <- readRDS("output/icl_fit_prior.RDS")

mute(iclFit['ICL plot'])
```

```{r echo=FALSE, fig.width=6, fig.height=4}
mute(iclFitPrior['ICL plot'])
```

**11. ábra** A G=1 és G=10 közti megoldások ICL ábrái ( a felső a prior opció nélkül, az alsó pedig ezzel kiegészített lefutás )

A *priorControl()* hangolási opció nélkül, a felső ábra szerint hasonlóképpen a VEV keveréktípus a legjobb az ICL információs kritérium szeriunt is, akár G=9, akár G=10 opciót tekintjük is.

A finomhangolással együtt azonban (alsó ábra) a VVI eloszlástípus mutat kedvezőbb illeszkedést. Ezt úgy értelmezem, hogy méretükben, tengelyeik hosszában eltérő, de a főtengelyekkel és egymás tengelyirányultságában egyező eloszlásokat modellez a legjobb ICL-lel leírható modell.

A VVI típus G=8 struktúra esetén tetőzik, így ezt fogadom el a legjobb megoldásnak, mely az alacsonyabb komponensszám miatt az értelmezhetőségben is kedvezőbb.

\newpage
## 6. Mentsd el a legjobb BIC-megoldást, tedd át ROPstatba és számítsd ki a Validálás modullal a főbb QC mutatókat! Hasonlítsd össze a kapott értékeket a 8. óra 1. feladatában kapott QC-értékekkel!

Az alábbi táblázatban mutatom be a validálás eredményét.

A G=3, 9, 10 és 28 MKA konfigurációkat vetettem össze a korábbi k-középpontú elemzésekével, ahol k értéke 6, 7, 8 és 9  között mozgott.

Jól láthatóan a G=3 megoldás, noha magyarázott varianciája 51.52%-os, mind  a PB, mind módosított Xie-Beni, mind a Solhouette mutatók, tekintetében egy a KKA-s elemzésekhez hasonlatos eredménnyel szolgált, noha átlagos homogenitása kedvezőtlenebb, GDI24 és CL mutatói is jobbnak mondhatóak mint a többi MKA megoldásé, és közelebb állnak az KKA-hoz.
Emögött azt gondolom, hogy a jól elhatárolható három klaszter áll, alacsony átfedéssel.

A G = 9, 10  MKA megoldások redundáns eloszláskomponens-szerkezete, a sok klaszterátfedés folytán egy a magyarázott varianciában alig jobb (54.99%-58.49%), és nagyon rossz szeparációs mutatókkal jellemezhető struktúrák. Hasonlóképpen, noha BIC-szempontból az exploratív elemzésnél kiemelkedő volt a G=28 megoldás, EESS%-a alig éri el a közepes KKA elemzésést, miközben minden egyéb QC-jában alul teljesít, talán CLdeltája kivétel egyedül.  

```{r echo=FALSE}
qcs <- read_delim("output/QC.txt", delim="\t")
knitr::kable(qcs, "simple")
```

**1. táblázat** Adekvációs mutatók összevetése


